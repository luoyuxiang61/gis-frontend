<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>GIS3.22</title>

    <style>
      html,body {
        height:100%;
        width:100%;
        margin:0;
      }
      body {
        background-color:#FFF;
        overflow:hidden;
        font-family:"Trebuchet MS";
      }
        #blueHead{
          height:3%;
          width: 100%;
          background-color: rgba(231, 234, 235, 0.822);
        }

        #mainWindow{
          width:100%; height:97%;
        }
          #map {
            height: 100%;
            width: 100%;
            margin:0px;
            padding:0px;
          }
          #layerListDiv{height:auto;max-height:400px;width:170px;background-color:rgb(255, 255, 255);position:absolute;left:15px;top:152px;z-index:999;overflow:auto;padding-left:5px;box-shadow: 5px 5px 2px #888888;}
          .layerListItem.groupLayer{margin-bottom:5px;}
          .layerListItem.groupLayer:hover{background-color: rgba(177, 174, 169, 0.815);}
          .layerListItem.layer:hover{background-color: rgba(218, 217, 216, 0.685);}
          .labelItem{display:inline-block;width:85%;}
          .labelItem.groupLayer{display:inline-block;width:85%;cursor:pointer;}
      #toolbar{
        position:absolute;top:10px;right:100px;width:auto;height:auto;background-color:rgb(255, 255,255);z-index:999;padding:5px;padding-bottom:0px;border:1px solid black;border-radius:3px
      }
        .icon{
          height:25px;width:25px;z-index:999;cursor:pointer;
        }

      
      #tool{
        position: absolute;
        top: 60px;
        right: 100px;
        height: auto;
        width: auto;
        z-index: 999;
      }
        #draw{
          height:auto;width:138px;z-index:999;background-color:#fff;
        }
        #measure{
          height:auto;z-Index:999;width:150px;background-color:#FFF;
        }
        #bookmark{
          background-color: #fff;
        }




      #titlePane{
        width:280px;
      }
      .action-button {
        font-size: 16px;
        background-color: transparent;
        border: 1px solid #D3D3D3;
        color: #6e6e6e;
        height: 32px;
        width: 32px;
        text-align: center;
        box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
        
      }
      .action-button:hover{
        background-color:rgba(6, 121, 121, 0.637);
      }

      .no{
        display: none;
      }

      </style>
      <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
      <script src="./js/jcookie/jquery.cookie.js"></script>
      <script>
        var depart = $.cookie('user');    

        if(depart==undefined) window.location.href='login.html';
      </script>

      <link rel="stylesheet" href="https://js.arcgis.com/3.22/esri/themes/calcite/dijit/calcite.css">
      <link rel="stylesheet" href="https://js.arcgis.com/3.22/esri/themes/calcite/esri/esri.css">
      <script src="https://js.arcgis.com/3.22/"></script>
      <!-- <script src="https://182.254.152.78/arcgis_js_api/library/3.22/3.22/init.js"></script> -->

  </head>

  <body class="calcite">
    <div id="blueHead">
      <div style="float:right">
          <p style="display:inline">您好，管理员</p>
          <a href="./服务管理.html">后台管理</a>&nbsp;&nbsp;&nbsp;
          <a href="./login.html">退出</a>
      </div>

    </div>

    <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false">
      <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
        
        <!-- 工具条 -->
        <div id="toolbar">
          <img class="icon" src="./images/measure.png" alt="measure"  title="量测">
          <img class="icon" src="./images/draw.png" alt="draw"  title="绘图">
          <img class="icon" src="./images/bookmark.png" alt="bookmark"  title="书签">
          <img class="icon" src="./images/print.png" alt="print"  title="打印">
        </div>

        <!-- 工具条下方显示工具 -->
        <div id="tool" class="no">
          <img id="closeTool" src="./images/close.png" width="10px" height="10px" onselectstart="return false">
            
          <div>
            <!-- 画图工具 -->
            <div class="no tool" id="draw" onselectstart="return false">
                <button class="action-button esri-icon-blank-map-pin" id="point" type="button"
                  title="点"></button>
                <button class="action-button esri-icon-polyline" id="polyline" type="button"
                  title="多段线"></button>
                <button class="action-button esri-icon-polygon" id="polygon" type="button"
                  title="多边形"></button>
                <button class="action-button esri-icon-trash" id="clear" type="button" title="清除草图"></button>
           </div>

            <!-- 量测工具 -->
            <div class="no tool" id="measure">
                <div id="measurementDiv"></div>   
            </div>

            <!-- 书签 -->
            <div class="no tool" id="bookmark">
                <div id="bookmarksDiv"></div>
            </div>

            <!-- 打印 -->
            <div class="no tool" id="print"></div>
          </div>

        </div> 



        <!-- 底图切换按钮 -->
        <div style="position:absolute; right:10px; top:10px; z-Index:999;">      
            <div id="basemapToggleDiv"></div>          
        </div>

        <!-- 比例尺 -->
        <div style="position:absolute; right:150px; bottom:25px; z-Index:999;">      
          <div id="scaleBarDiv"></div>          
        </div>

        <!-- 鹰眼视图 -->
        <div style="position:absolute; left:10px; bottom:230px; z-Index:999;">      
          <div id="overviewDiv" style="width:200px;height:200px"></div>          
        </div>

        <!-- 全局视图 -->
        <div style="position:absolute; left:15px; top:80px; z-Index:999;">      
          <div id="homeButtonDiv"></div>          
        </div>

        <!-- 图层控制 -->
        <img id="layersToggle" src="./images/layerControl.png" style="width:30px;height:30px;background-color:#fff;position:absolute; left:15px; top:120px; z-Index:999;cursor:pointer" alt="">
        <div  id="layerListDiv" onselectstart="return false">
          <ul id="layerList" style="list-style:none;padding-left:0px">
          </ul>
        </div>

        <!-- 图例 -->
        <div style="position:absolute; right:0px; bottom:50px;min-height:1px;max-height:40%;z-Index:999;overflow:auto;background-color:#FFF;width:180px;">      
          <div id="legendDiv"></div>          
        </div>

      

      </div>
    </div>


    <script>
        var map, tb;
        require([
            "dojo/dom",
            "dojo/on",
            "esri/Color",
            "dojo/keys",
            "dojo/parser",
            "dojo/_base/array",
    
            "esri/config",
            "esri/sniff",
            "esri/map",
            "esri/SnappingManager",
            "esri/dijit/Measurement",
            "esri/layers/FeatureLayer",
            "esri/renderers/SimpleRenderer",
            "esri/tasks/GeometryService",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/PictureFillSymbol",
            "esri/symbols/CartographicLineSymbol",
    
    
            "esri/basemaps",
            "esri/dijit/BasemapToggle",
            "esri/InfoTemplate",
            "esri/units",
            "esri/dijit/OverviewMap",
            "esri/dijit/Bookmarks",
            "esri/dijit/Scalebar",
            "esri/dijit/HomeButton",
            "esri/toolbars/draw",
            "esri/graphic",
            "esri/dijit/LayerList",
            "esri/dijit/Legend",
            "esri/layers/ArcGISTiledMapServiceLayer",
            "esri/dijit/Print",
    
    
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane",
            "dijit/TitlePane",
            "dijit/form/CheckBox",
            "dojo/domReady!"
          ], function(
            dom,on,Color, keys, parser,arrayUtils,
            esriConfig, has, Map, SnappingManager, Measurement, FeatureLayer, SimpleRenderer, GeometryService,SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,PictureFillSymbol,
            CartographicLineSymbol,esriBasemaps,BasemapToggle,InfoTemplate,Units,OverviewMap,Bookmarks,Scalebar,HomeButton,Draw, Graphic,LayerList,Legend,ArcGISTiledMapServiceLayer,
            Print
    
    
          ) {
            parser.parse();
            //This sample may require a proxy page to handle communications with the ArcGIS Server services. You will need to
            //replace the url below with the location of a proxy on your machine. See the 'Using the proxy page' help topic
            //for details on setting up a proxy page.
            esriConfig.defaults.io.proxyUrl = "/proxy/";
            esriConfig.defaults.io.alwaysUseProxy = false;
    
            //This service is for development and testing purposes only. We recommend that you create your own geometry service for use within your applications
            esriConfig.defaults.geometryService = new GeometryService("http://localhost:6080/arcgis/rest/services/Utilities/Geometry/GeometryServer");
    
    
            /*底图部分*/
            //基础底图
            esriBasemaps.jcdt = {
              baseMapLayers: [{url: ""}
              ],
              thumbnailUrl: "https://js.arcgis.com/3.15/esri/images/basemap/streets.jpg",
              title: "基础底图"
            };
            //影像底图
            esriBasemaps.yxdt = {
              baseMapLayers: [{url: ""}
              ],
              thumbnailUrl: "https://js.arcgis.com/3.15/esri/images/basemap/satellite.jpg",
              title: "影像底图"
            };
            

            
    
            
            /*数据图层部分*/
    
            var infoTemplate = new InfoTemplate("属性", "${*}");
            var myLayers = [];
            var showLayers = [];
            var legendLayers = []; 
              $.ajaxSetup (
                {
                   async: false
                });
    
                $.get("http://localhost:3000/myLayers?depart="+depart,function(layers){
                  myLayers = layers;
                })
              
            
                var nowGroup = " ";
                for(var i=0;i<myLayers.length;i++){

                  
                  var oneLayer = myLayers[i];

                  //图形量算服务
                  // if(oneLayer.LayerType=="GeometryService"){
                  //   esriConfig.defaults.geometryService = new GeometryService(oneLayer.ServiceUrl);
                  // }



                  //图层组
                  if(oneLayer.LayerType=="GroupLayer"){
                    nowGroup = oneLayer.DisplayName;
                    $("#layerList").append("<li class='layerListItem groupLayer "+nowGroup+"'><input class='inputItem groupLayer' type='checkbox'><label class='labelItem groupLayer'><strong>"+oneLayer.DisplayName+"</strong></label></li>");
                  };

                  //瓦片地图服务
                  if(oneLayer.LayerType=="TiledService"){

                    if(oneLayer.DisplayName==="基础底图"){
                      esriBasemaps.jcdt.baseMapLayers[0].url=oneLayer.ServiceUrl;
                    }
                    
                    if(oneLayer.DisplayName==="影像底图"){
                      esriBasemaps.yxdt.baseMapLayers[0].url=oneLayer.ServiceUrl;
                    }


                    $("#layerList").append("<li class='layerListItem layer "+nowGroup+"' style='padding-left:8px;display:none;'><input class='inputItem layer' type='checkbox'><label class='labelItem layer'>"+oneLayer.DisplayName+"</label></li>");
                    var lyr = new ArcGISTiledMapServiceLayer(oneLayer.ServiceUrl,{
                      id:oneLayer.DisplayName,
                      visible:false
                    })

                    showLayers.push(lyr);
                    
                  }
                    
                  //要素图层
                  if(myLayers[i].LayerType==="FeatureLayer" && myLayers[i].ServiceUrl!=null){
                    $("#layerList").append("<li class='layerListItem layer "+nowGroup+"' style='padding-left:8px;display:none'><input class='inputItem layer' type='checkbox'><label class='labelItem layer'>"+oneLayer.DisplayName+"</label></li>");

                    var lyr =  new FeatureLayer(myLayers[i].ServiceUrl,{
                      id:myLayers[i].DisplayName,
                      visible:false,
                      outFields:["*"],
                      infoTemplate:infoTemplate
                    });

                    if(myLayers[i].IsLegend==1) {

                      legendLayers.push(lyr);
                    };

                    showLayers.push(lyr);
                  }
                }
    
                
            
            map = new Map("map", {
              basemap: "jcdt",
              logo:false
            });
    
    
    
            map.addLayers(showLayers);
    
    
    
    
    
            //画图工具
            map.on("load", initToolbar);
            // markerSymbol is used for point and multipoint, see http://raphaeljs.com/icons/#talkq for more examples
            var markerSymbol = new SimpleMarkerSymbol();
            markerSymbol.setPath("M16,4.938c-7.732,0-14,4.701-14,10.5c0,1.981,0.741,3.833,2.016,5.414L2,25.272l5.613-1.44c2.339,1.316,5.237,2.106,8.387,2.106c7.732,0,14-4.701,14-10.5S23.732,4.938,16,4.938zM16.868,21.375h-1.969v-1.889h1.969V21.375zM16.772,18.094h-1.777l-0.176-8.083h2.113L16.772,18.094z");
            markerSymbol.setColor(new Color("#00FFFF"));
    
            // lineSymbol used for freehand polyline, polyline and line. 
            var lineSymbol = new CartographicLineSymbol(
              CartographicLineSymbol.STYLE_SOLID,
              new Color([255,0,0]), 10, 
              CartographicLineSymbol.CAP_ROUND,
              CartographicLineSymbol.JOIN_MITER, 5
            );
    
            // fill symbol used for extent, polygon and freehand polygon, use a picture fill symbol
            // the images folder contains additional fill images, other options: sand.png, swamp.png or stiple.png
            var fillSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
            new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
            new Color([255,0,0]), 2),new Color([255,0,0,0.25])
            );
    
            function initToolbar() {
              tb = new Draw(map);
              tb.on("draw-end", addGraphic);
    
              // event delegation so a click handler is not
              // needed for each individual button
              on(dom.byId("draw"), "click", function(evt) {
                if ( evt.target.id === "draw" || evt.target.id==="") {
                  return;
                }
    
                if( evt.target.id === "clear"){
                  map.graphics.clear();
                  return;
                }
                var tool = evt.target.id.toLowerCase();
                map.disableMapNavigation();
                tb.activate(tool);
              });
            }
    
            function addGraphic(evt) {
              //deactivate the toolbar and clear existing graphics 
              tb.deactivate(); 
              map.enableMapNavigation();
    
              // figure out which symbol to use
              var symbol;
              if ( evt.geometry.type === "point" || evt.geometry.type === "multipoint") {
                symbol = markerSymbol;
              } else if ( evt.geometry.type === "line" || evt.geometry.type === "polyline") {
                symbol = lineSymbol;
              }
              else {
                symbol = fillSymbol;
              }
    
              map.graphics.add(new Graphic(evt.geometry, symbol));
            }
            
    
            //量测工具
            var measurement = new Measurement({
              map: map,
              defaultAreaUnit: Units.SQUARE_KILOMETERS,
              defaultLengthUnit: Units.KILOMETERS
            }, dom.byId("measurementDiv"));
            measurement.startup();
            
    
            //底图切换按钮
            var toggle = new BasemapToggle({
              map: map,
              basemap:"yxdt"
            }, dom.byId("basemapToggleDiv"));
            toggle.startup();
    
    
            //鹰眼视图
            var overviewMapDijit = new OverviewMap({
              map: map,
              visible: false,
              attachTo:"bottom-left"
            });
            overviewMapDijit.startup();
    
            //书签
            var bookmarks = new Bookmarks({
                map: map,
                bookmarks: [],
                editable: true
              }, "bookmarksDiv");
    
    
            //比例尺
            var scalebar = new Scalebar({
            map: map,
            scalebarUnit:"metric"
              },dom.byId("scaleBarDiv"));
    
    
            //全局视图home
            var homeButton = new HomeButton({
            theme: "HomeButton",
            map: map,
            extent: null,
            visible: true
              }, dom.byId("homeButtonDiv"));
            homeButton.startup();
    
    
            //打印
            var printer = new Print({
              map: map,
              url: "http://localhost:6080/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
            }, dom.byId("print"));
            printer.startup();
    
            
            var layerInfos = [];
            for(var i = 0;i<legendLayers.length;i++){
              layerInfos[i] = {
                layer:legendLayers[i],
                title:legendLayers[i].id
              }
            }

  
            //图例
            var legendDijit = new Legend({
                map: map,
                layerInfos:layerInfos
              }, "legendDiv");
              legendDijit.startup();
    
    



              //图层控制点击之后
              //非图层组（点击前面的checkbox)
              $(".inputItem.layer").click(function(){
              var liCheckbox = $(this);
              var groupLayerName = liCheckbox.parent().attr('class').substr(20,10).trim();
              var checked = liCheckbox.prop('checked');
              var liLabel = liCheckbox.next();
              var layerName = liLabel.text();       
              if(checked){
                liCheckbox.prop('checked',true);
                map.getLayer(layerName).setVisibility(true);
                var groupLi = $(".layerListItem.groupLayer."+groupLayerName);
                $(groupLi.children()[0]).prop('checked',true);
              }else{
                liCheckbox.prop('checked',false);
                map.getLayer(layerName).setVisibility(false);
                var subLayers = $(".layerListItem.layer."+groupLayerName);
                
                var groupLi = $(".layerListItem.groupLayer."+groupLayerName);
                $(groupLi.children()[0]).prop('checked',false);

                for(var i=0;i<subLayers.length;i++){
                  var checked = $($(subLayers[i]).children()[0]).prop('checked');
                  if(checked) $(groupLi.children()[0]).prop('checked',true);
                }


              }
              })
              //非图层组（点击后面的label)
              $(".labelItem.layer").click(function(){
                var label = $(this);
                var groupLayerName = label.parent().attr('class').substr(20,10).trim();
                var layerName = label.text();
                var checkbox = label.prev();
                var checked = checkbox.prop('checked');

                if(!checked){
                checkbox.prop('checked',true);
                map.getLayer(layerName).setVisibility(true);
                var groupLi = $(".layerListItem.groupLayer."+groupLayerName);
                $(groupLi.children()[0]).prop('checked',true);
    
                }else{
                  checkbox.prop('checked',false);
                  map.getLayer(layerName).setVisibility(false);
                  var subLayers = $(".layerListItem.layer."+groupLayerName);       
                  var groupLi = $(".layerListItem.groupLayer."+groupLayerName);
                  $(groupLi.children()[0]).prop('checked',false);
                  for(var i=0;i<subLayers.length;i++){
                    var checked = $($(subLayers[i]).children()[0]).prop('checked');
                    if(checked) $(groupLi.children()[0]).prop('checked',true);
                  }
                }               
              })





              //图层组
              //点击前面的checkbox
              $(".inputItem.groupLayer").click(function(){
                var liCheckbox = $(this);
                var checked = liCheckbox.prop('checked');
                var liLabel = liCheckbox.next();
                var layerName = liLabel.text();

                if(checked){
                  $(".layerListItem.layer."+layerName).show(200);
                  var subLayers = $($(".layerListItem.layer."+layerName));             
                  for(var i=0;i<subLayers.length;i++){
                    var checkbox = $(subLayers[i]).children()[0];
                    var label = $(subLayers[i]).children()[1];
                    $(checkbox).prop('checked',true);
                    var sLayerName = $(label).text();
                    map.getLayer(sLayerName).setVisibility(true);
                  }



                }else {
                  $(".layerListItem.layer."+layerName).hide(200);
                  var subLayers = $($(".layerListItem.layer."+layerName));             
                  for(var i=0;i<subLayers.length;i++){
                    var checkbox = $(subLayers[i]).children()[0];
                    var label = $(subLayers[i]).children()[1];
                    $(checkbox).prop('checked',false);
                    var sLayerName = $(label).text();
                    map.getLayer(sLayerName).setVisibility(false);
                  }
                };
              })
              //点击后面的label
              $(".labelItem.groupLayer").click(function(){
                var label = $(this);
                var layerName = label.text();

               

                var display =  $(".layerListItem.layer."+layerName).css("display");
                
                if(display == "none")$(".layerListItem.layer."+layerName).show(150);
                else $(".layerListItem.layer."+layerName).hide(150);
      
              })





          // toobar点击
          var toolId0 = "xx";
          $(".icon").click(function(){

            var toolId = $(this).prop("alt");



            if(toolId!=toolId0) {
              $(".tool").hide();
              $("#tool").show();
              $("#"+toolId).show();
            }
            else {
              if($("#tool").css("display")=="none"){
                $("#tool").show();
              }
              else $("#tool").hide(200);
            }
            toolId0 = toolId;
          })
          //关闭tool
          $("#closeTool").click(function(){
            $("#tool").hide(200);
          })


          //图层控制toggle
          $("#layersToggle").click(function(){
            $("#layerListDiv").toggle(150);
          })





    
          });
        </script>
  </body>
</html>