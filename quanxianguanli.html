<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>用户管理</title>
  <script src="./config.js"></script>
  <link rel="stylesheet" href="./lib/bootstrap-3.3.7/css/bootstrap.min.css">
  <style media="screen">
    html,
    body {
      height: 100%;
      width: 100%;
    }

    .list-group-item.depa {
      padding: 2px;
      text-align: center;
    }

    .btn-group-lg>.btn,
    .btn-lg {
      padding: 10px 8px;
      font-size: 18px;
      line-height: 1.3333333;
      border-radius: 0px;
      font-size: 100%;
      font-style: oblique;
      font-weight: bold;
      text-align: left;
    }

    .list-group.depa {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    ul.son {
      display: none
    }

    ul.son li:hover {
      background-color: azure
    }

    .list-group-item.father:hover {
      background-color: bisque
    }
  </style>
</head>

<body>
  <!-- 最上方横条装饰 -->
  <div class="" style="height:5%;background-color:rgb(218, 180, 202);">
  </div>

  <!-- 第二行，导航栏 -->
  <ul class="nav nav-tabs">
    <li role="presentation" class="active">
      <a href="#">用户管理</a>
    </li>
    <li role="presentation">
      <a href="fuwuguanli.html">服务管理</a>
    </li>
    <li role="presentation">
      <a href="#">设备管理</a>
    </li>
    <li role="presentation">
      <a href="#">数据字典</a>
    </li>
  </ul>


  <!-- 主界面容器 -->
  <div class="container-fluid" style="height:89%;">
    <!-- 容器一分为二，横向排列-->
    <div class="row" style="height:100%">
      <!-- 左边的目录树，在PC上占比为2/12，在移动端占比为4/12，主要是为了在移动端是还能看全目录树上的元素的字 -->
      <div id="sideTree" class="col-xs-4 col-md-2" style="height:100%;padding:0;background-color:#efefff">
      </div>


      <div class="col-xs-8 col-md-10" style="height:100%;padding:0;">
        <div class="row" style="height:100%;margin:0px;padding:5px;">

          <div id="layerList" class="col-md-3" style="overflow:auto;height:100%;max-height:100%;background-color:rgba(127, 255, 212, 0.575);">

          </div>
          <div id="fieldList" class="col-md-3" style="height:100%;max-height:100%;overflow:auto;background-color:aquamarine;">

          </div>
        </div>

      </div>
    </div>
  </div>





  <script src="./lib/jquery-3.2.1.min.js"></script>
  <script src="./lib/jcookie/jquery.cookie.js"></script>
  <script src="./lib/bootstrap-3.3.7/js/bootstrap.min.js"></script>

  <script>
    var departments = []

    $.ajax({
      type: 'get',
      async: false,
      url: "http://" + serverIP + ":" + serverPort + "/departmentsForTree",
      success: function (departmentsForTree) {
        for (var i = 0; i < departmentsForTree.length; i++) {

          var item = departmentsForTree[i];
          var sonshtml = "<div class='list-group depa' style='display:none'>";
          for (var j = 0; j < item.grps.length; j++) {
            sonshtml += "<a href='#' class='list-group-item sonli depa' grpId=" + item.grps[j].id + ">" + item.grps[
              j].name + "</a>";
          }
          sonshtml += "</div>";
          $("#sideTree").append(
            "<button type='button' class='btn btn-default btn-lg btn-block'><span class='glyphicon glyphicon-chevron-right' aria-hidden='true'</span>" +
            item.depa.name + "</button>" + sonshtml)
        }

        // 左边子元素点击变为深蓝色
        $(".sonli").click(function () {
          $(".list-group-item.depa").removeClass("active");
          $(this).addClass("active");
          var grpId = $(this).attr('grpId')
          var user = JSON.parse($.cookie('user'))
          console.log(user);
          $.ajax({
            type: 'post',
            url: "http://" + serverIP + ":" + serverPort + "/layersForGroup",
            data: {
              groupId: user.groupId
            },
            success: function (res) {
              console.log(res)

            }
          })

          $.ajax({
            type: 'post',
            url: "http://" + serverIP + ":" + serverPort + "/fieldsForGroup",
            data: {
              groupId: user.groupId
            },
            success: function (res) {
              console.log(res)
            }
          })

        })

        // 左边树状图点击父元素显示或者关闭子元素
        $("button.btn-block").click(function () {
          if ($(this).is(".active")) {
            $(this).removeClass("active");
            $(this).next().hide();
            $(this).children("span").removeClass("glyphicon-chevron-down");
            $(this).children("span").addClass("glyphicon-chevron-right");
          } else {
            $("button.btn-block").removeClass("active");
            $(this).addClass("active");
            $(".list-group.depa").hide();
            $(this).next().show();
            $("button.btn-block").children("span").removeClass("glyphicon-chevron-down");
            $("button.btn-block").children("span").addClass("glyphicon-chevron-right");
            $(this).children("span").removeClass("glyphicon-chevron-right");
            $(this).children("span").addClass("glyphicon-chevron-down");
          }

        })
      }
    })


    $.ajax({
      type: 'post',
      url: "http://" + serverIP + ":" + serverPort + "/layersForTree",
      success: function (layersForTree) {
        var sonshtml = '';
        for (var i = 0; i < layersForTree.length; i++) {
          sonshtml += "<div class='list-group-item father' flag='0' onclick='showSons(this)'><input type='checkbox'>" + "<strong>" + layersForTree[i].father.DisplayName + "</strong></div>"
          sonshtml += "<ul class='list-group son' style='padding-left:15px;margin-bottom:3px'>"
          for (var j = 0; j < layersForTree[i].sons.length; j++) {
            sonshtml += "<li class='list-group-item' flag='0' onclick='clickSon(this)'>" + "<input type='checkbox'>" + "<a href='#' onclick='showFields(this)'>" + layersForTree[i].sons[j].DisplayName + "</a></li>"
          }
          sonshtml += "</ul>"
        }
        $("#layerList").append(
          "<div class='list-group' onselectstart='return false'> <div class='list-group-item'><input type='checkbox'>全选</div>" + sonshtml + "</div>"
        )
      }
    })



    function showSons(el) {

      var checkFlag = $(el).attr('flag') == '1' ? true : false

      var checked = $($(el).children()[0]).prop('checked');
      if (checkFlag != checked) {
        if (checked) {
          $(el).next().show()
        } else {
          $(el).next().hide()
        }


        $(el).attr('flag', checked == true ? '1' : '0');
        var sonLis = $($(el).next().children());
        for (var i = 0; i < sonLis.length; i++) {
          $(sonLis[i].children[0]).prop('checked', checked);
        }
      } else {
        $(el).next().toggle()
      }
    }

    function showFields(el) {
      console.log('show fields');
    }



    function clickSon(el) {
      var sonCheckFlag = $(el).attr('flag')
      var sonChecked = $($(el).children()[0]).prop('checked');
      var fatherCheckbox = $($($(el).parent().prev()).children()[0]);

      if (sonChecked) {
        fatherCheckbox.prop('checked', true);
        $(el).attr('flag', '1');
      } else {
        fatherCheckbox.prop('checked', false);
        $(el).attr('flag', '0');

        var sonLis1 = $(el).parent().children()
        console.log(sonLis1);
        for (var i = 0; i < sonLis1.length; i++) {
          if ($($(sonLis1[i]).children()[0]).prop('checked')) {
            fatherCheckbox.prop('checked', true);
            $(el).attr('flag', '1');
          }
          // console.log($($(sonLis1[i]).children()[0]).prop('checked'));
        }


      }
    }
  </script>





</body>

</html>